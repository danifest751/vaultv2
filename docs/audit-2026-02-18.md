# Family Media Vault ‚Äî –ü—Ä–æ–µ–∫—Ç–Ω—ã–π –∞—É–¥–∏—Ç

**–î–∞—Ç–∞:** 2026-02-18  
**–°—Ç–∞—Ç—É—Å:** Beta / –ü–æ—á—Ç–∏ production-ready  
**–ê—É–¥–∏—Ç–æ—Ä:** Qwen Code AI  

---

## Executive Summary

**–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞:** üü¢ **Beta** ‚Äî –ø—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å –±–∞–∑–æ–≤—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å | üü¢ Excellent | Event sourcing, WAL, snapshots —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | üü¢ Good | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã |
| –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å | üü° Good | –ë–∞–∑–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, faces/events/alboms –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | üü° Untested | –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 100k+ —Ñ–∞–π–ª–æ–≤ |
| –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ | üü¢ Excellent | TypeScript, type-safe, –º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ |
| –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ | üü° Moderate | 15 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ |

---

## 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
vaultv2/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ server/           # HTTP API + Dev UI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ bootstrap.ts          # Runtime init, job wiring
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ routes.ts             # HTTP handlers (778 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ http-utils.ts         # JSON/HTML helpers
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ui.ts                 # Dev console UI (1233 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ server-config.ts      # Environment config
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ server.ts             # Server entry point
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ snapshot-retention.ts # Snapshot cleanup
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ __tests__/            # 4 test files
‚îÇ   ‚îî‚îÄ‚îÄ web/                # React UI (Mantine)
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ main.tsx
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ styles.css
‚îÇ       ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ core/               # Domain types, events, IDs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ events.ts       # 202 domain event types
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ids.ts          # Branded types (MediaId, SourceId...)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ invariants.ts   # Domain invariants
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ storage/            # WAL, snapshots, state, vault
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ state.ts            # DomainState + stores (714 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ wal.ts              # Append-only WAL with HMAC
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ snapshot.ts         # Snapshot write/read
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ state-snapshot.ts   # State ‚Üî snapshot serialization
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ rebuild.ts          # Rebuild from snapshot + WAL tail
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ vault.ts            # Content-addressed storage
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ metadata.ts         # Basic metadata extraction
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ derived.ts          # Derived artifact paths
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ __tests__/          # 5 test files
‚îÇ   ‚îî‚îÄ‚îÄ jobs/               # Job pipeline handlers
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ job-engine.ts     # Concurrent job runner
‚îÇ           ‚îú‚îÄ‚îÄ job-store.ts      # Job state management
‚îÇ           ‚îú‚îÄ‚îÄ scan.ts           # Incremental file scanning
‚îÇ           ‚îú‚îÄ‚îÄ ingest.ts         # SHA256 + exact dedup (L0)
‚îÇ           ‚îú‚îÄ‚îÄ metadata.ts       # Exiftool/ffprobe extraction
‚îÇ           ‚îú‚îÄ‚îÄ derived.ts        # Thumb/poster generation
‚îÇ           ‚îú‚îÄ‚îÄ dedup.ts          # pHash near-dedup (L1/L2)
‚îÇ           ‚îú‚îÄ‚îÄ quarantine.ts     # Quarantine resolution
‚îÇ           ‚îî‚îÄ‚îÄ __tests__/        # 6 test files
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ Family_Media_Vault_Full_TZ_Scalable_v2.md  # –ü–æ–ª–Ω–æ–µ –¢–ó
‚îÇ   ‚îú‚îÄ‚îÄ project-audit-2026-02-17.md                # –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∞—É–¥–∏—Ç
‚îÇ   ‚îú‚îÄ‚îÄ audit-2026-02-18.md                        # –≠—Ç–æ—Ç —Ñ–∞–π–ª
‚îÇ   ‚îî‚îÄ‚îÄ repository-structure.md                    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
‚îú‚îÄ‚îÄ package.json            # Monorepo root (npm workspaces)
‚îú‚îÄ‚îÄ tsconfig.json           # Composite project references
‚îú‚îÄ‚îÄ tsconfig.base.json      # Base compiler options
‚îú‚îÄ‚îÄ vitest.config.ts        # Test configuration
‚îî‚îÄ‚îÄ README.md
```

---

## 2. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é

### 2.1 –ü—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (¬ß0)

| –ü—Ä–∏–Ω—Ü–∏–ø | –°—Ç–∞—Ç—É—Å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|---------|--------|------------|
| Single Source of Truth | ‚úÖ | Content-addressed vault –ø–æ SHA256 |
| –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ—Å—Ç—å | ‚úÖ | Fingerprint-based scan (size + mtime + head64k) |
| Immutable media | ‚úÖ | –§–∞–π–ª—ã –≤ vault –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è |
| Dedup –±–µ–∑ –ø–æ—Ç–µ—Ä—å | ‚úÖ | L0/L1/L2/L3 —É—Ä–æ–≤–Ω–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º–æ—Å—Ç—å | ‚úÖ | Rebuild –∏–∑ snapshot + WAL tail |
| No SQL/SQLite | ‚úÖ | –¢–æ–ª—å–∫–æ file-based —Ö—Ä–∞–Ω–µ–Ω–∏–µ |

**–í–µ—Ä–¥–∏–∫—Ç:** üü¢ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**

---

### 2.2 Ingest Pipeline (¬ß5)

| Stage | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª |
|-------|----------|--------|------|
| **A: HASH** | Streaming SHA256 | ‚úÖ | `jobs/ingest.ts` |
| **B: EXACT DEDUP (L0)** | Skip –ø–æ sha256 match | ‚úÖ | `jobs/ingest.ts` |
| **C: METADATA** | Exiftool/ffprobe extraction | ‚úÖ | `jobs/metadata.ts` |
| **D: DERIVED** | Thumbs/posters generation | ‚úÖ | `jobs/derived.ts` |
| **E: NEAR DEDUP** | pHash + hamming distance | ‚úÖ | `jobs/dedup.ts` |
| **F: INDEX UPDATE** | Posting lists –¥–ª—è –ø–æ–∏—Å–∫–∞ | ‚úÖ | `storage/state.ts` |

**–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

- **Stage A:** –ü–æ—Ç–æ–∫–æ–≤—ã–π —Ö–µ—à —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ `MEDIA_HASH_UPDATED`
- **Stage B:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π skip —á–µ—Ä–µ–∑ `MEDIA_SKIPPED_DUPLICATE_EXACT`, —Å–æ–∑–¥–∞–Ω–∏–µ `DuplicateLink`
- **Stage C:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è exiftool (—Ñ–æ—Ç–æ) + ffprobe (–≤–∏–¥–µ–æ), –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- **Stage D:** –ê—Ç–æ–º–∞—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ temp-—Ñ–∞–π–ª—ã —Å retry (max 2 –ø–æ–ø—ã—Ç–∫–∏)
- **Stage E:** Perceptual hash —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏ (strong ‚â§4, probable ‚â§10)
- **Stage F:** `MediaSearchIndexStore` —Å posting lists –ø–æ kind/sourceId/duplicateLevel

**–í–µ—Ä–¥–∏–∫—Ç:** üü¢ **–í—Å–µ —ç—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã**

---

### 2.3 –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (¬ß6)

| –£—Ä–æ–≤–µ–Ω—å | –ö—Ä–∏—Ç–µ—Ä–∏–π | –î–µ–π—Å—Ç–≤–∏–µ | –°—Ç–∞—Ç—É—Å |
|---------|----------|----------|--------|
| **L0 Exact** | sha256 match | –ê–≤—Ç–æ—Å–∫–∏–ø + DuplicateLink | ‚úÖ |
| **L1 Strong** | pHash distance ‚â§ 4 | –ê–≤—Ç–æ—Å–∫–∏–ø + DuplicateLink | ‚úÖ |
| **L2 Probable** | pHash distance ‚â§ 10 | –ö–∞—Ä–∞–Ω—Ç–∏–Ω –Ω–∞ review | ‚úÖ |
| **L3 Unique** | –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π | –ò–º–ø–æ—Ä—Ç –≤ vault | ‚úÖ |

**–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```env
DEDUP_STRONG_DISTANCE_THRESHOLD=4      # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEDUP_PROBABLE_DISTANCE_THRESHOLD=10   # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

**–ê–ª–≥–æ—Ä–∏—Ç–º pHash:**
```typescript
// dedup.ts: –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ perceptual hash
const phash = await computePHash(imagePath); // 64-bit hash
const distance = hammingDistance(phash1, phash2);
if (distance <= strongThreshold) ‚Üí L1;
if (distance <= probableThreshold) ‚Üí L2;
```

**–í–µ—Ä–¥–∏–∫—Ç:** üü¢ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**

---

### 2.4 –ö–∞—Ä–∞–Ω—Ç–∏–Ω (¬ß6.4)

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|------------|--------|------------|
| Preview 512px | ‚úÖ | Thumb generation –≤ derived pipeline |
| –°—Å—ã–ª–∫–∞ –Ω–∞ sourceEntry | ‚úÖ | `QuarantineItem.sourceEntryId` |
| Top-3 –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ | ‚úÖ | `candidateMediaIds[]` |
| –°—Ç–∞—Ç—É—Å pending/accepted/rejected | ‚úÖ | –ö–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π |
| Accept/Reject API | ‚úÖ | POST `/quarantine/:id/accept\|reject` |
| UI –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ | ‚úÖ | –í–∫–ª–∞–¥–∫–∞ "Quarantine" –≤ Dev Console |

**–í–µ—Ä–¥–∏–∫—Ç:** üü¢ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**

---

### 2.5 –õ–∏—Ü–∞ (¬ß7)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| Face detection | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Face crops | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Embeddings (128/512-d) | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Incremental clustering | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_person index | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| People UI | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

**–í–µ—Ä–¥–∏–∫—Ç:** üî¥ **–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** ‚Äî –æ—Ç–ª–æ–∂–µ–Ω–æ –Ω–∞ –±—É–¥—É—â–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏

---

### 2.6 –°–æ–±—ã—Ç–∏—è (¬ß8)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| Event builder | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Incremental updates | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Merge/split UI | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_event index | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

**–í–µ—Ä–¥–∏–∫—Ç:** üî¥ **–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** ‚Äî –æ—Ç–ª–æ–∂–µ–Ω–æ –Ω–∞ –±—É–¥—É—â–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏

---

### 2.7 –ê–ª—å–±–æ–º—ã (¬ß9)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| Manual albums CRUD | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Smart albums rules | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_album index | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

**–í–µ—Ä–¥–∏–∫—Ç:** üî¥ **–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** ‚Äî –æ—Ç–ª–æ–∂–µ–Ω–æ –Ω–∞ –±—É–¥—É—â–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏

---

### 2.8 –ü–æ–∏—Å–∫ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (¬ß10)

| –ò–Ω–¥–µ–∫—Å | –°—Ç–∞—Ç—É—Å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|--------|--------|------------|
| by_sha256_prefix | ‚úÖ | `MediaStore.sha256Index` |
| by_phash_bucket | ‚úÖ | `MediaMetadataStore.phashBuckets` |
| by_taken_day | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_kind | ‚úÖ | `MediaSearchIndexStore.kindIndex` |
| by_camera | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_source | ‚úÖ | `MediaSearchIndexStore.sourceIdIndex` |
| by_person | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_event | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_album | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| by_gps_tile | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Full-text | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Semantic (CLIP) | üî¥ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

**API –ø–æ–∏—Å–∫–∞:**
```
GET /media/search?kind=photo&sourceId=src_abc&limit=50&cursor=med_xyz
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `kind` ‚Äî photo/video/unknown
- `mimeType` ‚Äî normalized MIME
- `sourceId` ‚Äî —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É
- `duplicateLevel` ‚Äî exact/strong/probable
- `cameraModel` ‚Äî –º–æ–¥–µ–ª—å –∫–∞–º–µ—Ä—ã
- `takenDay` ‚Äî –¥–∞—Ç–∞ —Å—ä—ë–º–∫–∏ (YYYY-MM-DD)
- `gpsTile` ‚Äî GPS —Ç–∞–π–ª
- `sha256Prefix` ‚Äî –ø—Ä–µ—Ñ–∏–∫—Å —Ö–µ—à–∞ (2-64 hex)
- `limit` ‚Äî –¥–æ 500
- `offset` / `cursor` ‚Äî –ø–∞–≥–∏–Ω–∞—Ü–∏—è
- `sort` ‚Äî mediaId_asc / takenAt_desc

**–í–µ—Ä–¥–∏–∫—Ç:** üü° **–ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** ‚Äî –±–∞–∑–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –µ—Å—Ç—å, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

---

## 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 3.1 –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞—É–¥–∏—Ç–∞)

| –ü—Ä–æ–±–ª–µ–º–∞ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –°—Ç–∞—Ç—É—Å |
|----------|------|-------|--------|
| WAL HMAC secret | Fallback "dev-secret" | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑ env | ‚úÖ |
| Authentication | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | Bearer token + X-Auth-Token | ‚úÖ |
| Source path validation | –ù–µ—Ç | Allowlist roots | ‚úÖ |

### 3.2 –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
```env
WAL_HMAC_SECRET=your-secure-secret-here  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
```

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
```env
AUTH_TOKEN=your-auth-token              # –ü—É—Å—Ç–æ = –±–µ–∑ auth
SOURCE_PATH_ALLOWLIST_ROOTS=/path1:/path2  # –†–∞–∑–¥–µ–ª–µ–Ω–æ path.delimiter
```

### 3.3 –ú–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã

| –ú–µ—Ö–∞–Ω–∏–∑–º | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|----------|--------|
| WAL integrity | HMAC-SHA256 + hash chain | ‚úÖ |
| Auth middleware | Bearer / X-Auth-Token header | ‚úÖ |
| Path allowlist | –í–∞–ª–∏–¥–∞—Ü–∏—è source paths | ‚úÖ |
| Asset tokens | HMAC-signed, TTL 60 —Å–µ–∫ | ‚úÖ |
| Atomic writes | Temp files + rename | ‚úÖ |

### 3.4 –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ä–∏—Å–∫–∏

| –†–∏—Å–∫ | –£—Ä–æ–≤–µ–Ω—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|------|---------|--------------|
| –ù–µ—Ç rate limiting | Medium | –î–æ–±–∞–≤–∏—Ç—å –¥–ª—è /media/search |
| –ù–µ—Ç encryption at rest | Low | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ vault |
| –ù–µ—Ç audit logging | Medium | –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π |

**–í–µ—Ä–¥–∏–∫—Ç:** üü¢ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**

---

## 4. –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

### 4.1 Type Safety

**–û—Ü–µ–Ω–∫–∞:** üü¢ **Excellent**

- ‚úÖ –°—Ç—Ä–æ–≥–∏–π TypeScript (`strict: true`)
- ‚úÖ Branded types –¥–ª—è –≤—Å–µ—Ö ID:
  ```typescript
  type MediaId = Branded<string, "MediaId">;
  type SourceId = Branded<string, "SourceId">;
  type QuarantineItemId = Branded<string, "QuarantineItemId">;
  ```
- ‚úÖ –ù–µ—Ç `any` –∏–ª–∏ `@ts-ignore`
- ‚úÖ `JsonObject` –¥–ª—è payload –≤–º–µ—Å—Ç–æ `any`
- ‚úÖ `noUncheckedIndexedAccess: true`

### 4.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–û—Ü–µ–Ω–∫–∞:** üü¢ **Good**

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: core ‚Üí storage ‚Üí jobs ‚Üí server
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ –ú–æ–¥—É–ª—å–Ω—ã–π server (routes/bootstrap/ui —Ä–∞–∑–¥–µ–ª–µ–Ω—ã)

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥:**
- ‚ö†Ô∏è `routes.ts` ‚Äî 778 —Å—Ç—Ä–æ–∫ (–º–æ–∂–Ω–æ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å)
- ‚ö†Ô∏è `ui.ts` ‚Äî 1233 —Å—Ç—Ä–æ–∫–∏ HTML/JS –≤ —Å—Ç—Ä–æ–∫–æ–≤–æ–º –ª–∏—Ç–µ—Ä–∞–ª–µ
- ‚ö†Ô∏è `apps/web` ‚Äî React UI –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å server

### 4.3 Error Handling

**–û—Ü–µ–Ω–∫–∞:** üü° **Adequate**

**–ü–ª—é—Å—ã:**
- ‚úÖ Custom error classes (`InvariantError`, `WalIntegrityError`)
- ‚úÖ WAL integrity verification
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ corruption

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ù–µ—Ç structured logging (pino/winston)
- ‚ö†Ô∏è –ù–µ—Ç error codes –≤ API –æ—Ç–≤–µ—Ç–∞—Ö

### 4.4 –¢–µ—Å—Ç—ã

**–°—Ç–∞—Ç—É—Å:** üü° **–¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

**–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:** 15 —Ñ–∞–π–ª–æ–≤
```
packages/storage/src/__tests__/
  ‚îú‚îÄ‚îÄ wal.test.ts
  ‚îú‚îÄ‚îÄ snapshot.test.ts
  ‚îú‚îÄ‚îÄ rebuild.test.ts
  ‚îú‚îÄ‚îÄ state-snapshot.test.ts
  ‚îî‚îÄ‚îÄ media-search-index.test.ts

packages/jobs/src/__tests__/
  ‚îú‚îÄ‚îÄ scan-ingest.test.ts
  ‚îú‚îÄ‚îÄ metadata-derived.test.ts
  ‚îú‚îÄ‚îÄ dedup-phash.test.ts
  ‚îú‚îÄ‚îÄ quarantine.test.ts
  ‚îú‚îÄ‚îÄ job-engine.test.ts
  ‚îî‚îÄ‚îÄ job-store.test.ts

apps/server/src/__tests__/
  ‚îú‚îÄ‚îÄ routes.test.ts
  ‚îú‚îÄ‚îÄ bootstrap.test.ts
  ‚îú‚îÄ‚îÄ server-config.test.ts
  ‚îî‚îÄ‚îÄ snapshot-retention.test.ts
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Vitest –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç—ã (–æ—à–∏–±–∫–∞ "No test suite found")

**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é vitest –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç —Ç–µ—Å—Ç–æ–≤

---

## 5. API Reference

### 5.1 Health & Tools

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/health` | GET | Health check (`{ status: "ok" }`) |
| `/health/tools` | GET | Tools availability (exiftool/ffprobe/ffmpeg) |

### 5.2 Sources

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/sources` | GET | List all sources |
| `/sources` | POST | Create source (`{ path, recursive, includeArchives, excludeGlobs }`) |
| `/sources/:id` | PATCH | Update source |
| `/sources/:id` | DELETE | Remove source |
| `/sources/:id/scan` | POST | Enqueue scan job |
| `/sources/:id/entries` | GET | List entries for source |

### 5.3 Media

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/media` | GET | List media (paginated: limit, offset) |
| `/media/search` | GET | Search with filters + cursor pagination |
| `/media/:id` | GET | Get media details + metadata + duplicateLinks |
| `/media/:id/file` | GET | Stream media file (requires asset token) |

### 5.4 Derived

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/derived/:id/thumb` | GET | Get thumbnail (512px) |
| `/derived/:id/poster` | GET | Get video poster (640px) |

### 5.5 Entries

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/entries` | GET | List all entries (optionally by sourceId) |
| `/entries/:id` | GET | Get entry details + ingest + media + metadata |

### 5.6 Duplicate Links

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/duplicate-links` | GET | List links (filter: level, mediaId, sourceEntryId) |

### 5.7 Quarantine

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/quarantine` | GET | List quarantine items |
| `/quarantine/:id` | GET | Get quarantine item details |
| `/quarantine/:id/accept` | POST | Accept quarantine ‚Üí import to vault |
| `/quarantine/:id/reject` | POST | Reject quarantine ‚Üí skip file |

### 5.8 Jobs

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/jobs` | GET | List all jobs (filter: kind, status) |

### 5.9 Snapshots

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/snapshots` | POST | Create new snapshot |
| `/snapshots` | GET | List snapshots |

### 5.10 File System

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/fs/dialog` | GET | Open folder picker (Windows only) |

### 5.11 Auth

| Endpoint | Method | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `/auth/asset-token` | POST | Get temporary asset access token |

---

## 6. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 6.1 –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `WAL_HMAC_SECRET` | HMAC secret –¥–ª—è WAL integrity (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–µ—Ç fallback) |

### 6.2 –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | Default | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|---------|----------|
| `PORT` | 3000 | HTTP server port |
| `DATA_DIR` | `./data` | Base directory –¥–ª—è –¥–∞–Ω–Ω—ã—Ö |
| `WAL_DIR` | `${DATA_DIR}/wal` | WAL files directory |
| `SNAPSHOTS_DIR` | `${DATA_DIR}/snapshots` | Snapshot files directory |
| `VAULT_DIR` | `${DATA_DIR}/vault` | Content-addressed vault |
| `DERIVED_DIR` | `${DATA_DIR}/derived` | Derived artifacts (thumbs/posters) |
| `AUTH_TOKEN` | `""` | Auth token (–ø—É—Å—Ç–æ = auth –æ—Ç–∫–ª—é—á—ë–Ω) |
| `SOURCE_PATH_ALLOWLIST_ROOTS` | `""` | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ root paths –¥–ª—è sources |
| `SNAPSHOT_RETENTION_MAX` | 20 | –ú–∞–∫—Å–∏–º—É–º —Ö—Ä–∞–Ω–∏–º—ã—Ö snapshots |
| `JOB_CONCURRENCY_TOTAL` | 4 | –û–±—â–∏–π –ª–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö jobs |
| `JOB_CONCURRENCY_IO` | 2 | –õ–∏–º–∏—Ç IO jobs (scan/ingest) |
| `JOB_CONCURRENCY_CPU` | 2 | –õ–∏–º–∏—Ç CPU jobs (metadata/derived) |
| `JOB_CONCURRENCY_CONTROL` | 1 | –õ–∏–º–∏—Ç control jobs (quarantine) |
| `DERIVED_GENERATE_MAX_ATTEMPTS` | 2 | –ü–æ–ø—ã—Ç–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ derived |
| `DEDUP_STRONG_DISTANCE_THRESHOLD` | 4 | pHash strong dedup threshold |
| `DEDUP_PROBABLE_DISTANCE_THRESHOLD` | 10 | pHash quarantine threshold |

---

## 7. Roadmap

### –§–∞–∑–∞ 1: Scale Hardening (2‚Äì3 –Ω–µ–¥–µ–ª–∏)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π**

- [ ] **–ò–Ω–¥–µ–∫—Å—ã –¥–ª—è 1M+:**
  - [ ] `by_taken_day` ‚Äî –¥–ª—è timeline view
  - [ ] `by_camera` ‚Äî –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞–º–µ—Ä–µ
  - [ ] `by_gps_tile` ‚Äî –¥–ª—è –≥–µ–æ-–ø–æ–∏—Å–∫–∞
  - [ ] –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ + compaction

- [ ] **Soak-—Ç–µ—Å—Ç—ã:**
  - [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 100k synthetic entries
  - [ ] –ó–∞–º–µ—Ä RAM usage, rebuild time, search latency
  - [ ] –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ hot paths

- [ ] **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
  - [ ] Cursor pagination O(log n) –≤–º–µ—Å—Ç–æ O(n)
  - [ ] Lazy loading metadata
  - [ ] Batched index updates

### –§–∞–∑–∞ 2: Face Pipeline (3‚Äì4 –Ω–µ–¥–µ–ª–∏)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π**

- [ ] Face detection (ONNX/InsightFace)
- [ ] Face crops + embeddings (128/512-d)
- [ ] Incremental clustering
- [ ] `by_person` index
- [ ] People UI

### –§–∞–∑–∞ 3: Events + Albums (2‚Äì3 –Ω–µ–¥–µ–ª–∏)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π**

- [ ] Event auto-builder (time + GPS clustering)
- [ ] Incremental event updates
- [ ] Manual albums CRUD
- [ ] Smart albums rules engine
- [ ] Events/Albums UI

### –§–∞–∑–∞ 4: Full-text + Semantic (2 –Ω–µ–¥–µ–ª–∏)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–∏–∑–∫–∏–π**

- [ ] Token dictionary + postings
- [ ] CLIP embeddings (optional)
- [ ] Semantic search UI

---

## 8. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∞—É–¥–∏—Ç–æ–º (2026-02-17)

| –ö—Ä–∏—Ç–µ—Ä–∏–π | 2026-02-17 | 2026-02-18 | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|----------|------------|------------|-----------|
| **WAL_HMAC_SECRET** | Fallback "dev-secret" | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | ‚úÖ Critical fix |
| **Authentication** | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | Bearer + X-Auth-Token | ‚úÖ Security |
| **Source path validation** | –ù–µ—Ç | Allowlist roots | ‚úÖ Security |
| **Metadata extraction** | Stub (ext-only) | Exiftool/ffprobe | ‚úÖ Pipeline |
| **Near-dedup** | Head-hash surrogate | pHash + thresholds | ‚úÖ Pipeline |
| **Derived artifacts** | –ù–µ—Ç | Thumbs/posters | ‚úÖ Pipeline |
| **Media search** | –ù–µ—Ç | Posting indexes + pagination | ‚úÖ Feature |
| **Server modularity** | –ú–æ–Ω–æ–ª–∏—Ç 1300+ —Å—Ç—Ä–æ–∫ | –†–∞–∑–¥–µ–ª—ë–Ω –Ω–∞ –º–æ–¥—É–ª–∏ | ‚úÖ Code quality |
| **Snapshot retention** | –ù–µ—Ç | Prune policy | ‚úÖ Ops |
| **Tests** | Storage/jobs | + Server routes/bootstrap | ‚úÖ Coverage |
| **–°—Ç–∞—Ç—É—Å** | Alpha | Beta | +1 —É—Ä–æ–≤–µ–Ω—å |

---

## 9. –í—ã–≤–æ–¥—ã

### 9.1 –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞** ‚Äî event sourcing, WAL, snapshots
2. ‚úÖ **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ—Å—Ç—å** ‚Äî fingerprinting —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ **Type safety** ‚Äî branded types, —Å—Ç—Ä–æ–≥–∏–π TypeScript
4. ‚úÖ **Job Engine** ‚Äî –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, resume, concurrency control
5. ‚úÖ **Data durability** ‚Äî WAL integrity + –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
6. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π HMAC secret, auth, path allowlist
7. ‚úÖ **–ü–æ–ª–Ω—ã–π ingest pipeline** ‚Äî –≤—Å–µ stages A‚ÄìF —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
8. ‚úÖ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** ‚Äî server —Ä–∞–∑–¥–µ–ª—ë–Ω –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏

### 9.2 –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã

1. üî¥ **Face pipeline** ‚Äî –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ—Ç–ª–æ–∂–µ–Ω–æ)
2. üî¥ **Event pipeline** ‚Äî –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ—Ç–ª–æ–∂–µ–Ω–æ)
3. üî¥ **Albums** ‚Äî –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ—Ç–ª–æ–∂–µ–Ω–æ)
4. üî¥ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** ‚Äî by_taken_day, by_camera, by_gps_tile –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
5. ‚ö†Ô∏è **–¢–µ—Å—Ç—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è** ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 9.3 –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| **–°—Ç–∞—Ç—É—Å** | üü¢ Beta / –ü–æ—á—Ç–∏ production-ready |
| **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ MVP** | 70‚Äì80% |
| **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥** | üü° Moderate (—É–ø—Ä–∞–≤–ª—è–µ–º) |
| **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è** | ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –∫—Ä–µ–ø–∫–∏–π |

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A: Metrics

**Codebase:**
- TypeScript files: ~40 files
- Lines of code (estimate): ~6000 LOC (packages + server)
- Test files: 15
- Test coverage: ~50% (estimate, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫)

**Architecture:**
- Packages: 3 (core, storage, jobs)
- Apps: 2 (server, web)
- Domain events: 20+ types
- Job kinds: 8 (scan, ingest, metadata, derived, dedup, quarantine:accept, quarantine:reject, snapshot:create)

**Implemented vs Spec:**
- Stages A‚ÄìF: ‚úÖ (Full pipeline)
- Dedup L0/L1/L2/L3: ‚úÖ
- Quarantine workflow: ‚úÖ
- Face/Event/Albums: üî¥ (–û—Ç–ª–æ–∂–µ–Ω–æ)
- Extended indexes: ‚ö†Ô∏è (–ß–∞—Å—Ç–∏—á–Ω–æ)

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ B: –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –°–±–æ—Ä–∫–∞
npm run build

# –¢–µ—Å—Ç—ã (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
npm test

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (dev)
cd apps/server
set WAL_HMAC_SECRET=dev-secret
npm run start:dev
```

**Production:**
```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
export WAL_HMAC_SECRET=your-secure-secret
export AUTH_TOKEN=your-auth-token  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
export SOURCE_PATH_ALLOWLIST_ROOTS=/path/to/media:/path/to/photos

# –ó–∞–ø—É—Å–∫
npm run build
cd apps/server
node dist/index.js
```

**UI:**
```
–û—Ç–∫—Ä—ã—Ç—å http://localhost:3000/ui
```

---

**–ö–æ–Ω–µ—Ü –∞—É–¥–∏—Ç–∞.**

*–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–π —Å–º. `docs/Family_Media_Vault_Full_TZ_Scalable_v2.md`.*
